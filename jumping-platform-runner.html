<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ã‚¸ãƒ£ãƒ³ãƒ”ãƒ³ã‚°ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ©ãƒ³ãƒŠãƒ¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            overflow: hidden;
        }
        
        #gameContainer {
            position: relative;
            border-radius: 15px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }
        
        #gameCanvas {
            display: block;
            background: linear-gradient(to bottom, #87CEEB 0%, #98D8E8 100%);
            cursor: pointer;
            touch-action: none;  /* ã‚¿ãƒƒãƒæ“ä½œã®æœ€é©åŒ– */
            user-select: none;   /* ãƒ†ã‚­ã‚¹ãƒˆé¸æŠã‚’ç„¡åŠ¹åŒ– */
        }
        
        #gameOverlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            background: rgba(0, 0, 0, 0.7);
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
        }
        
        #gameOverlay.show {
            opacity: 1;
            pointer-events: all;
        }
        
        .gameTitle {
            color: white;
            font-size: 32px;
            font-weight: bold;
            margin-bottom: 20px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .gameText {
            color: white;
            font-size: 24px;
            margin: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        .button {
            margin-top: 20px;
            padding: 15px 40px;
            font-size: 20px;
            font-weight: bold;
            color: white;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border: none;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }
        
        .button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }
        
        .button:active {
            transform: translateY(0);
        }
        
        #scoreDisplay {
            position: absolute;
            top: 20px;
            right: 20px;
            color: white;
            font-size: 20px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        #highScoreDisplay {
            position: absolute;
            top: 50px;
            right: 20px;
            color: #FFD700;
            font-size: 16px;
            font-weight: bold;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.5);
        }
        
        #soundToggle {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            transition: transform 0.2s;
        }
        
        #soundToggle:hover {
            transform: scale(1.1);
        }
        
        .loadingText {
            color: white;
            font-size: 16px;
            margin-top: 10px;
            opacity: 0.8;
        }
    </style>
</head>
<body>
    <div id="gameContainer">
        <canvas id="gameCanvas" width="800" height="400"></canvas>
        <div id="scoreDisplay">ã‚¹ã‚³ã‚¢: 0</div>
        <div id="highScoreDisplay">ãƒã‚¤ã‚¹ã‚³ã‚¢: 0</div>
        <button id="soundToggle" onclick="toggleSound()">ğŸ”Š</button>
        
        <div id="gameOverlay" class="show">
            <h1 class="gameTitle">ã‚¸ãƒ£ãƒ³ãƒ”ãƒ³ã‚°ãƒ—ãƒ©ãƒƒãƒˆãƒ•ã‚©ãƒ¼ãƒ ãƒ©ãƒ³ãƒŠãƒ¼</h1>
            <p class="gameText">éšœå®³ç‰©ã‚’é£›ã³è¶Šãˆã¦ç”Ÿãæ®‹ã‚ã†ï¼</p>
            <p class="gameText" style="font-size: 18px;">é•·æŠ¼ã—ã§é«˜ãã‚¸ãƒ£ãƒ³ãƒ—ã€çŸ­æŠ¼ã—ã§ä½ãã‚¸ãƒ£ãƒ³ãƒ—</p>
            <p class="gameText" style="font-size: 16px; opacity: 0.8;">ã‚¹ãƒšãƒ¼ã‚¹ã‚­ãƒ¼/ã‚¯ãƒªãƒƒã‚¯/ã‚¿ãƒƒãƒ—ã§æ“ä½œ</p>
            <button class="button" onclick="initAndStart()">ã‚²ãƒ¼ãƒ ã‚¹ã‚¿ãƒ¼ãƒˆ</button>
            <p class="loadingText" id="loadingText" style="display: none;">ã‚µã‚¦ãƒ³ãƒ‰èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        const overlay = document.getElementById('gameOverlay');
        const scoreDisplay = document.getElementById('scoreDisplay');
        const highScoreDisplay = document.getElementById('highScoreDisplay');
        const soundToggleBtn = document.getElementById('soundToggle');
        const loadingText = document.getElementById('loadingText');
        
        // ã‚²ãƒ¼ãƒ å¤‰æ•°
        let gameRunning = false;
        let score = 0;
        let highScore = localStorage.getItem('highScore') || 0;
        let gameSpeed = 3;
        let speedIncreaseTimer = 0;
        let soundEnabled = true;
        let audioInitialized = false;
        
        // ã‚µã‚¦ãƒ³ãƒ‰é–¢é€£ã®å¤‰æ•°
        let bgmLoop = null;
        let synth = null;
        let jumpSynth = null;
        let gameOverSynth = null;
        let pointSynth = null;
        let speedUpSynth = null;
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼
        const player = {
            x: 100,
            y: 200,
            width: 40,
            height: 40,
            velocityY: 0,
            jumping: false,
            jumpPower: -12,
            gravity: 0.5,
            color: '#FF6B6B',
            rotation: 0,
            isCharging: false,
            chargeTime: 0,
            minJumpPower: -6,   // æœ€å°ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆä½ã„éšœå®³ç‰©ç”¨ï¼‰
            maxJumpPower: -15,  // æœ€å¤§ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆé«˜ã„éšœå®³ç‰©ç”¨ï¼‰
            chargeColor: '#FF6B6B'
        };
        
        // éšœå®³ç‰©
        let obstacles = [];
        let obstacleTimer = 0;
        let lastObstacleScored = null;
        
        // é›£æ˜“åº¦é–¢é€£
        let difficultyLevel = 0;
        let baseObstacleInterval = 100;  // åˆæœŸã®éšœå®³ç‰©é–“éš”ï¼ˆåºƒã‚ï¼‰
        let obstacleRandomness = 20;     // åˆæœŸã®ãƒ©ãƒ³ãƒ€ãƒ æ€§ï¼ˆå°ã•ã‚ï¼‰
        
        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
        let particles = [];
        
        // èƒŒæ™¯è¦ç´ 
        let clouds = [];
        let mountains = [];
        
        // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã®åˆæœŸåŒ–
        async function initAudio() {
            if (audioInitialized) return;
            
            loadingText.style.display = 'block';
            
            await Tone.start();
            
            // ãƒ¡ã‚¤ãƒ³ã‚·ãƒ³ã‚»ã‚µã‚¤ã‚¶ãƒ¼ï¼ˆBGMç”¨ï¼‰
            synth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "square8" },
                envelope: {
                    attack: 0.02,
                    decay: 0.1,
                    sustain: 0.3,
                    release: 0.4
                }
            }).toDestination();
            synth.volume.value = -15;
            
            // ã‚¸ãƒ£ãƒ³ãƒ—éŸ³ç”¨ã‚·ãƒ³ã‚»
            jumpSynth = new Tone.Synth({
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.01,
                    decay: 0.2,
                    sustain: 0,
                    release: 0.1
                }
            }).toDestination();
            jumpSynth.volume.value = -10;
            
            // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼éŸ³ç”¨ã‚·ãƒ³ã‚»
            gameOverSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sawtooth" },
                envelope: {
                    attack: 0.01,
                    decay: 0.3,
                    sustain: 0.1,
                    release: 0.5
                }
            }).toDestination();
            gameOverSynth.volume.value = -8;
            
            // ãƒã‚¤ãƒ³ãƒˆç²å¾—éŸ³ç”¨ã‚·ãƒ³ã‚»
            pointSynth = new Tone.Synth({
                oscillator: { type: "triangle" },
                envelope: {
                    attack: 0.01,
                    decay: 0.1,
                    sustain: 0,
                    release: 0.1
                }
            }).toDestination();
            pointSynth.volume.value = -12;
            
            // ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—éŸ³ç”¨ã‚·ãƒ³ã‚»
            speedUpSynth = new Tone.PolySynth(Tone.Synth, {
                oscillator: { type: "sine" },
                envelope: {
                    attack: 0.01,
                    decay: 0.2,
                    sustain: 0.1,
                    release: 0.3
                }
            }).toDestination();
            speedUpSynth.volume.value = -10;
            
            // BGMãƒ«ãƒ¼ãƒ—ã®ä½œæˆ
            createBGM();
            
            audioInitialized = true;
            loadingText.style.display = 'none';
        }
        
        // BGMã®ä½œæˆ
        function createBGM() {
            const bgmPattern = [
                { time: "0:0", note: "C4", duration: "8n" },
                { time: "0:0:2", note: "E4", duration: "8n" },
                { time: "0:1", note: "G4", duration: "8n" },
                { time: "0:1:2", note: "E4", duration: "8n" },
                { time: "0:2", note: "C4", duration: "8n" },
                { time: "0:2:2", note: "E4", duration: "8n" },
                { time: "0:3", note: "G4", duration: "8n" },
                { time: "0:3:2", note: "B4", duration: "8n" },
                
                { time: "1:0", note: "A3", duration: "8n" },
                { time: "1:0:2", note: "C4", duration: "8n" },
                { time: "1:1", note: "E4", duration: "8n" },
                { time: "1:1:2", note: "C4", duration: "8n" },
                { time: "1:2", note: "A3", duration: "8n" },
                { time: "1:2:2", note: "C4", duration: "8n" },
                { time: "1:3", note: "E4", duration: "8n" },
                { time: "1:3:2", note: "G4", duration: "8n" },
                
                { time: "2:0", note: "F3", duration: "8n" },
                { time: "2:0:2", note: "A3", duration: "8n" },
                { time: "2:1", note: "C4", duration: "8n" },
                { time: "2:1:2", note: "A3", duration: "8n" },
                { time: "2:2", note: "G3", duration: "8n" },
                { time: "2:2:2", note: "B3", duration: "8n" },
                { time: "2:3", note: "D4", duration: "8n" },
                { time: "2:3:2", note: "G4", duration: "8n" },
                
                { time: "3:0", note: "C4", duration: "8n" },
                { time: "3:0:2", note: "E4", duration: "8n" },
                { time: "3:1", note: "G4", duration: "8n" },
                { time: "3:1:2", note: "C5", duration: "8n" },
                { time: "3:2", note: "G4", duration: "8n" },
                { time: "3:2:2", note: "E4", duration: "8n" },
                { time: "3:3", note: "C4", duration: "4n" }
            ];
            
            bgmLoop = new Tone.Part((time, note) => {
                if (soundEnabled) {
                    synth.triggerAttackRelease(note.note, note.duration, time);
                }
            }, bgmPattern.map(p => [p.time, { note: p.note, duration: p.duration }]));
            
            bgmLoop.loop = true;
            bgmLoop.loopEnd = "4m";
            Tone.Transport.bpm.value = 140;
        }
        
        // BGMé–‹å§‹
        function startBGM() {
            if (bgmLoop && soundEnabled) {
                Tone.Transport.start();
                bgmLoop.start(0);
            }
        }
        
        // BGMåœæ­¢
        function stopBGM() {
            if (bgmLoop) {
                bgmLoop.stop();
                Tone.Transport.stop();
            }
        }
        
        // ã‚¸ãƒ£ãƒ³ãƒ—éŸ³
        function playJumpSound(chargeRatio = 0) {
            if (soundEnabled && jumpSynth) {
                if (chargeRatio < 0.3) {
                    // å°ã‚¸ãƒ£ãƒ³ãƒ—éŸ³ï¼ˆé«˜ãçŸ­ã„éŸ³ï¼‰
                    jumpSynth.triggerAttackRelease("E5", "16n");
                } else if (chargeRatio < 0.7) {
                    // ä¸­ã‚¸ãƒ£ãƒ³ãƒ—éŸ³
                    jumpSynth.triggerAttackRelease("C5", "8n");
                    setTimeout(() => {
                        jumpSynth.triggerAttackRelease("E5", "8n");
                    }, 50);
                } else {
                    // å¤§ã‚¸ãƒ£ãƒ³ãƒ—éŸ³ï¼ˆåŠ›å¼·ã„éŸ³ï¼‰
                    jumpSynth.triggerAttackRelease("G4", "8n");
                    setTimeout(() => {
                        jumpSynth.triggerAttackRelease("C5", "8n");
                    }, 30);
                    setTimeout(() => {
                        jumpSynth.triggerAttackRelease("G5", "8n");
                    }, 60);
                }
            }
        }
        
        // ãƒã‚¤ãƒ³ãƒˆç²å¾—éŸ³
        function playPointSound() {
            if (soundEnabled && pointSynth) {
                pointSynth.triggerAttackRelease("G5", "16n");
                setTimeout(() => {
                    pointSynth.triggerAttackRelease("C6", "16n");
                }, 30);
            }
        }
        
        // ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚¢ãƒƒãƒ—éŸ³
        function playSpeedUpSound() {
            if (soundEnabled && speedUpSynth) {
                speedUpSynth.triggerAttackRelease(["C4", "E4", "G4", "C5"], "4n");
            }
        }
        
        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼éŸ³
        function playGameOverSound() {
            if (soundEnabled && gameOverSynth) {
                gameOverSynth.triggerAttackRelease(["C4", "Eb4", "G3"], "2n");
            }
        }
        
        // ã‚µã‚¦ãƒ³ãƒ‰ã®ã‚ªãƒ³/ã‚ªãƒ•åˆ‡ã‚Šæ›¿ãˆ
        function toggleSound() {
            soundEnabled = !soundEnabled;
            soundToggleBtn.textContent = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
            
            if (!soundEnabled) {
                stopBGM();
            } else if (gameRunning) {
                startBGM();
            }
        }
        
        // ãƒ‘ãƒ©ãƒ©ãƒƒã‚¯ã‚¹èƒŒæ™¯ã®åˆæœŸåŒ–
        function initBackground() {
            // é›²ã®ç”Ÿæˆ
            clouds = [];
            for (let i = 0; i < 5; i++) {
                clouds.push({
                    x: Math.random() * canvas.width,
                    y: Math.random() * 150,
                    width: 60 + Math.random() * 40,
                    speed: 0.5 + Math.random() * 0.5
                });
            }
            
            // å±±ã®ç”Ÿæˆ
            mountains = [];
            for (let i = 0; i < 3; i++) {
                mountains.push({
                    x: i * 300,
                    width: 200 + Math.random() * 100,
                    height: 100 + Math.random() * 50,
                    color: `hsl(${260 + Math.random() * 40}, 30%, ${40 + Math.random() * 20}%)`
                });
            }
        }
        
        // èƒŒæ™¯ã®æç”»
        function drawBackground() {
            // ã‚°ãƒ©ãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³èƒŒæ™¯
            const gradient = ctx.createLinearGradient(0, 0, 0, canvas.height);
            gradient.addColorStop(0, '#87CEEB');
            gradient.addColorStop(1, '#98D8E8');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // å¤ªé™½
            ctx.beginPath();
            ctx.arc(650, 80, 30, 0, Math.PI * 2);
            ctx.fillStyle = '#FFD700';
            ctx.fill();
            ctx.closePath();
            
            // é›²ã®æç”»ã¨ç§»å‹•
            clouds.forEach(cloud => {
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.beginPath();
                ctx.ellipse(cloud.x, cloud.y, cloud.width/2, 20, 0, 0, Math.PI * 2);
                ctx.ellipse(cloud.x - 20, cloud.y, cloud.width/3, 15, 0, 0, Math.PI * 2);
                ctx.ellipse(cloud.x + 20, cloud.y, cloud.width/3, 15, 0, 0, Math.PI * 2);
                ctx.fill();
                
                cloud.x -= cloud.speed * gameSpeed/3;
                if (cloud.x < -cloud.width) {
                    cloud.x = canvas.width + cloud.width;
                }
            });
            
            // å±±ã®æç”»ã¨ç§»å‹•
            mountains.forEach(mountain => {
                ctx.fillStyle = mountain.color;
                ctx.beginPath();
                ctx.moveTo(mountain.x, canvas.height - 100);
                ctx.lineTo(mountain.x + mountain.width/2, canvas.height - 100 - mountain.height);
                ctx.lineTo(mountain.x + mountain.width, canvas.height - 100);
                ctx.closePath();
                ctx.fill();
                
                mountain.x -= gameSpeed * 0.3;
                if (mountain.x < -mountain.width) {
                    mountain.x = canvas.width;
                }
            });
        }
        
        // åœ°é¢ã®æç”»
        function drawGround() {
            // åœ°é¢
            ctx.fillStyle = '#4CAF50';
            ctx.fillRect(0, canvas.height - 100, canvas.width, 100);
            
            // è‰ã®ãƒ†ã‚¯ã‚¹ãƒãƒ£
            ctx.fillStyle = '#45A049';
            for (let i = 0; i < canvas.width; i += 20) {
                ctx.fillRect(i, canvas.height - 100, 2, 10);
                ctx.fillRect(i + 10, canvas.height - 95, 2, 8);
            }
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æç”»
        function drawPlayer() {
            ctx.save();
            ctx.translate(player.x + player.width/2, player.y + player.height/2);
            ctx.rotate(player.rotation);
            
            // ãƒãƒ£ãƒ¼ã‚¸ä¸­ã®ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
            if (player.isCharging) {
                const chargeRatio = Math.min(player.chargeTime / 30, 1);
                const glowSize = 5 + chargeRatio * 15;
                const gradient = ctx.createRadialGradient(0, 0, 0, 0, 0, glowSize);
                gradient.addColorStop(0, `hsla(${60 - chargeRatio * 60}, 100%, 60%, ${0.3 + chargeRatio * 0.3})`);
                gradient.addColorStop(1, 'transparent');
                ctx.fillStyle = gradient;
                ctx.fillRect(-glowSize, -glowSize, glowSize * 2, glowSize * 2);
            }
            
            // æœ¬ä½“ï¼ˆãƒãƒ£ãƒ¼ã‚¸ã«å¿œã˜ã¦è‰²ã‚’å¤‰åŒ–ï¼‰
            if (player.isCharging) {
                const chargeRatio = Math.min(player.chargeTime / 30, 1);
                const hue = 60 - chargeRatio * 60; // é»„è‰²ã‹ã‚‰èµ¤ã¸
                player.chargeColor = `hsl(${hue}, 70%, 60%)`;
                ctx.fillStyle = player.chargeColor;
            } else {
                ctx.fillStyle = player.color;
            }
            ctx.fillRect(-player.width/2, -player.height/2, player.width, player.height);
            
            // ç›®
            ctx.fillStyle = 'white';
            ctx.fillRect(-player.width/2 + 5, -player.height/2 + 8, 8, 8);
            ctx.fillRect(-player.width/2 + 20, -player.height/2 + 8, 8, 8);
            
            ctx.fillStyle = 'black';
            ctx.fillRect(-player.width/2 + 7, -player.height/2 + 10, 4, 4);
            ctx.fillRect(-player.width/2 + 22, -player.height/2 + 10, 4, 4);
            
            // ç¬‘é¡”ï¼ˆãƒãƒ£ãƒ¼ã‚¸ä¸­ã¯é›†ä¸­é¡”ï¼‰
            ctx.strokeStyle = 'white';
            ctx.lineWidth = 2;
            ctx.beginPath();
            if (player.isCharging) {
                // é›†ä¸­ã—ã¦ã„ã‚‹è¡¨æƒ…
                ctx.moveTo(-8, 5);
                ctx.lineTo(8, 5);
            } else {
                // é€šå¸¸ã®ç¬‘é¡”
                ctx.arc(0, 5, 10, 0, Math.PI);
            }
            ctx.stroke();
            
            ctx.restore();
            
            // ãƒãƒ£ãƒ¼ã‚¸ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ï¼ˆè¶³å…ƒã«è¡¨ç¤ºï¼‰
            if (player.isCharging && !player.jumping) {
                const chargeRatio = Math.min(player.chargeTime / 30, 1);
                const barWidth = player.width * chargeRatio;
                
                // ãƒãƒ¼ã®èƒŒæ™¯
                ctx.fillStyle = 'rgba(0, 0, 0, 0.3)';
                ctx.fillRect(player.x, player.y + player.height + 5, player.width, 6);
                
                // ãƒãƒ¼ã®æ 
                ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                ctx.lineWidth = 1;
                ctx.strokeRect(player.x, player.y + player.height + 5, player.width, 6);
                
                // ãƒãƒ£ãƒ¼ã‚¸ãƒãƒ¼
                const gradient = ctx.createLinearGradient(player.x, 0, player.x + barWidth, 0);
                gradient.addColorStop(0, '#FFD700');
                gradient.addColorStop(1, '#FF4444');
                ctx.fillStyle = gradient;
                ctx.fillRect(player.x, player.y + player.height + 5, barWidth, 6);
                
                // æœ€å¤§ãƒãƒ£ãƒ¼ã‚¸æ™‚ã®è¼ã
                if (chargeRatio >= 1) {
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.8)';
                    ctx.lineWidth = 2;
                    ctx.strokeRect(player.x - 1, player.y + player.height + 4, player.width + 2, 8);
                }
            }
        }
        
        // éšœå®³ç‰©ã®ç”Ÿæˆ
        function createObstacle() {
            const types = ['box', 'spike', 'tall'];
            // é›£æ˜“åº¦ãŒä¸ŠãŒã‚‹ã»ã©å±é™ºãªéšœå®³ç‰©ã®ç¢ºç‡ãŒä¸ŠãŒã‚‹
            let typeWeights = [3, 1, 1];  // åˆæœŸã¯ç®±ãŒå¤šã‚
            if (difficultyLevel > 3) {
                typeWeights = [2, 2, 1];  // ä¸­ç›¤ã¯ã‚¹ãƒ‘ã‚¤ã‚¯ã‚‚å¢—ãˆã‚‹
            }
            if (difficultyLevel > 6) {
                typeWeights = [1, 2, 2];  // å¾ŒåŠã¯é«˜ã„éšœå®³ç‰©ã¨ã‚¹ãƒ‘ã‚¤ã‚¯ãŒå¤šã‚
            }
            
            // é‡ã¿ä»˜ããƒ©ãƒ³ãƒ€ãƒ é¸æŠ
            const totalWeight = typeWeights.reduce((a, b) => a + b, 0);
            let random = Math.random() * totalWeight;
            let typeIndex = 0;
            for (let i = 0; i < typeWeights.length; i++) {
                random -= typeWeights[i];
                if (random <= 0) {
                    typeIndex = i;
                    break;
                }
            }
            const type = types[typeIndex];
            
            let obstacle = {
                x: canvas.width,
                type: type,
                color: '',
                scored: false
            };
            
            // éšœå®³ç‰©ã®ã‚µã‚¤ã‚ºã‚’å°‘ã—èª¿æ•´ï¼ˆé«˜ã•èª¿æ•´å¯èƒ½ãªã‚¸ãƒ£ãƒ³ãƒ—ã«å¯¾å¿œï¼‰
            switch(type) {
                case 'box':
                    obstacle.y = canvas.height - 135;
                    obstacle.width = 30;
                    obstacle.height = 35;
                    obstacle.color = '#FF9800';
                    break;
                case 'spike':
                    obstacle.y = canvas.height - 115;
                    obstacle.width = 25;
                    obstacle.height = 15;
                    obstacle.color = '#F44336';
                    break;
                case 'tall':
                    obstacle.y = canvas.height - 155;
                    obstacle.width = 20;
                    obstacle.height = 55;
                    obstacle.color = '#9C27B0';
                    break;
            }
            
            obstacles.push(obstacle);
            
            // æ™‚ã€…é€£ç¶šéšœå®³ç‰©ã‚’ç”Ÿæˆï¼ˆé›£æ˜“åº¦ãŒä¸ŠãŒã‚‹ã¨ç¢ºç‡ãŒä¸ŠãŒã‚‹ï¼‰
            if (difficultyLevel > 4 && Math.random() < 0.2 + (difficultyLevel * 0.02)) {
                setTimeout(() => {
                    if (gameRunning) {
                        const secondType = Math.random() < 0.7 ? 'spike' : 'box';
                        obstacles.push({
                            x: canvas.width,
                            y: secondType === 'spike' ? canvas.height - 115 : canvas.height - 135,
                            width: secondType === 'spike' ? 25 : 30,
                            height: secondType === 'spike' ? 15 : 35,
                            type: secondType,
                            color: secondType === 'spike' ? '#F44336' : '#FF9800',
                            scored: false
                        });
                    }
                }, 400);
            }
        }
        
        // éšœå®³ç‰©ã®æç”»
        function drawObstacles() {
            obstacles.forEach(obstacle => {
                ctx.fillStyle = obstacle.color;
                
                if (obstacle.type === 'spike') {
                    // ã‚¹ãƒ‘ã‚¤ã‚¯ã®æç”»
                    ctx.beginPath();
                    ctx.moveTo(obstacle.x, obstacle.y + obstacle.height);
                    ctx.lineTo(obstacle.x + obstacle.width/2, obstacle.y);
                    ctx.lineTo(obstacle.x + obstacle.width, obstacle.y + obstacle.height);
                    ctx.closePath();
                    ctx.fill();
                } else {
                    // ãƒœãƒƒã‚¯ã‚¹ã®æç”»
                    ctx.fillRect(obstacle.x, obstacle.y, obstacle.width, obstacle.height);
                    
                    // è£…é£¾
                    ctx.fillStyle = 'rgba(255,255,255,0.3)';
                    ctx.fillRect(obstacle.x + 2, obstacle.y + 2, obstacle.width - 4, 4);
                }
            });
        }
        
        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã®ç”Ÿæˆ
        function createParticle(x, y, isCharging = false) {
            if (isCharging) {
                // ãƒãƒ£ãƒ¼ã‚¸ä¸­ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ï¼ˆä¸Šæ˜‡ã™ã‚‹å…‰ï¼‰
                for (let i = 0; i < 2; i++) {
                    particles.push({
                        x: x + (Math.random() - 0.5) * 20,
                        y: y,
                        vx: (Math.random() - 0.5) * 1,
                        vy: -Math.random() * 2 - 1,
                        size: Math.random() * 4 + 2,
                        color: `hsl(${Math.random() * 60 + 30}, 100%, 70%)`,
                        life: 1
                    });
                }
            } else {
                // é€šå¸¸ã®ã‚¸ãƒ£ãƒ³ãƒ—ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«
                for (let i = 0; i < 5; i++) {
                    particles.push({
                        x: x,
                        y: y,
                        vx: (Math.random() - 0.5) * 4,
                        vy: Math.random() * -3 - 1,
                        size: Math.random() * 3 + 2,
                        color: `hsl(${Math.random() * 60 + 30}, 100%, 50%)`,
                        life: 1
                    });
                }
            }
        }
        
        // ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã®æ›´æ–°ã¨æç”»
        function updateParticles() {
            particles = particles.filter(particle => {
                particle.x += particle.vx;
                particle.y += particle.vy;
                // ãƒãƒ£ãƒ¼ã‚¸ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ã¯é‡åŠ›ãŒå¼±ã„
                if (particle.vy < 0) {
                    particle.vy += 0.1;
                } else {
                    particle.vy += 0.2;
                }
                particle.life -= 0.02;
                
                if (particle.life > 0) {
                    ctx.globalAlpha = particle.life;
                    ctx.fillStyle = particle.color;
                    ctx.fillRect(particle.x, particle.y, particle.size, particle.size);
                    ctx.globalAlpha = 1;
                    return true;
                }
                return false;
            });
        }
        
        // è¡çªåˆ¤å®š
        function checkCollision() {
            for (let obstacle of obstacles) {
                if (player.x < obstacle.x + obstacle.width &&
                    player.x + player.width > obstacle.x &&
                    player.y < obstacle.y + obstacle.height &&
                    player.y + player.height > obstacle.y) {
                    return true;
                }
            }
            return false;
        }
        
        // ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ã®æ›´æ–°
        function updatePlayer() {
            player.velocityY += player.gravity;
            player.y += player.velocityY;
            
            // åœ°é¢ã¨ã®è¡çª
            if (player.y > canvas.height - 140) {
                player.y = canvas.height - 140;
                player.velocityY = 0;
                player.jumping = false;
                player.rotation = 0;
            }
            
            // ãƒãƒ£ãƒ¼ã‚¸ä¸­ã®å‡¦ç†
            if (player.isCharging && !player.jumping) {
                player.chargeTime++;
                // ãƒãƒ£ãƒ¼ã‚¸ä¸­ã®ãƒ‘ãƒ¼ãƒ†ã‚£ã‚¯ãƒ«ç”Ÿæˆï¼ˆå°‘ãªã‚ï¼‰
                if (player.chargeTime % 5 === 0) {
                    createParticle(player.x + player.width/2, player.y + player.height, true);
                }
            }
            
            // ã‚¸ãƒ£ãƒ³ãƒ—ä¸­ã®å›è»¢
            if (player.jumping) {
                player.rotation += 0.1;
                createParticle(player.x + player.width/2, player.y + player.height, false);
            }
        }
        
        // ã‚¸ãƒ£ãƒ³ãƒ—ãƒãƒ£ãƒ¼ã‚¸é–‹å§‹
        function startJumpCharge() {
            if (!player.jumping && gameRunning) {
                player.isCharging = true;
                player.chargeTime = 0;
            }
        }
        
        // ã‚¸ãƒ£ãƒ³ãƒ—å®Ÿè¡Œ
        function executeJump() {
            if (!player.jumping && gameRunning) {
                if (player.isCharging) {
                    // ãƒãƒ£ãƒ¼ã‚¸æ™‚é–“ã«å¿œã˜ã¦ã‚¸ãƒ£ãƒ³ãƒ—åŠ›ã‚’è¨ˆç®—ï¼ˆ0ï½30ãƒ•ãƒ¬ãƒ¼ãƒ ã‚’0ï½1ã«æ­£è¦åŒ–ï¼‰
                    const chargeRatio = Math.min(player.chargeTime / 30, 1);
                    
                    // ã‚¸ãƒ£ãƒ³ãƒ—åŠ›ã‚’è¨ˆç®—ï¼ˆæœ€å°ã‹ã‚‰æœ€å¤§ã¾ã§ï¼‰
                    player.velocityY = player.minJumpPower - (player.maxJumpPower - player.minJumpPower) * chargeRatio;
                    
                    player.jumping = true;
                    player.isCharging = false;
                    
                    // ãƒãƒ£ãƒ¼ã‚¸é‡ã«å¿œã˜ãŸéŸ³ã‚’é³´ã‚‰ã™
                    playJumpSound(chargeRatio);
                    
                    // å¤§ã‚¸ãƒ£ãƒ³ãƒ—æ™‚ã¯è¿½åŠ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
                    if (chargeRatio > 0.7) {
                        for (let i = 0; i < 10; i++) {
                            createParticle(player.x + player.width/2, player.y + player.height, false);
                        }
                    }
                    
                    player.chargeTime = 0;
                } else {
                    // ãƒãƒ£ãƒ¼ã‚¸ãªã—ã®å³ã‚¸ãƒ£ãƒ³ãƒ—ï¼ˆæœ€å°ã‚¸ãƒ£ãƒ³ãƒ—ï¼‰
                    player.velocityY = player.minJumpPower;
                    player.jumping = true;
                    playJumpSound(0);
                }
            }
        }
        
        // ã‚²ãƒ¼ãƒ ã®æ›´æ–°
        function update() {
            if (!gameRunning) return;
            
            updatePlayer();
            
            // éšœå®³ç‰©ã®æ›´æ–°ã¨ãƒã‚¤ãƒ³ãƒˆç²å¾—ãƒã‚§ãƒƒã‚¯
            obstacles = obstacles.filter(obstacle => {
                obstacle.x -= gameSpeed;
                
                // éšœå®³ç‰©ã‚’é£›ã³è¶ŠãˆãŸã‚‰ãƒã‚¤ãƒ³ãƒˆéŸ³ã‚’é³´ã‚‰ã™
                if (!obstacle.scored && obstacle.x + obstacle.width < player.x) {
                    obstacle.scored = true;
                    playPointSound();
                }
                
                return obstacle.x > -50;
            });
            
            // é›£æ˜“åº¦ã«å¿œã˜ãŸéšœå®³ç‰©ã®ç”Ÿæˆé–“éš”ã‚’è¨ˆç®—
            const currentInterval = Math.max(
                40,  // æœ€å°é–“éš”ï¼ˆã“ã‚Œã‚ˆã‚ŠçŸ­ãã—ãªã„ï¼‰
                baseObstacleInterval - (difficultyLevel * 5)  // é›£æ˜“åº¦ãŒä¸ŠãŒã‚‹ã”ã¨ã«5ãƒ•ãƒ¬ãƒ¼ãƒ çŸ­ç¸®
            );
            const currentRandomness = Math.min(
                60,  // æœ€å¤§ãƒ©ãƒ³ãƒ€ãƒ æ€§
                obstacleRandomness + (difficultyLevel * 3)  // é›£æ˜“åº¦ãŒä¸ŠãŒã‚‹ã”ã¨ã«ãƒ©ãƒ³ãƒ€ãƒ æ€§å¢—åŠ 
            );
            
            // æ–°ã—ã„éšœå®³ç‰©ã®ç”Ÿæˆ
            obstacleTimer++;
            if (obstacleTimer > currentInterval + Math.random() * currentRandomness) {
                createObstacle();
                obstacleTimer = 0;
            }
            
            // ã‚¹ã‚³ã‚¢ã®æ›´æ–°
            score++;
            scoreDisplay.textContent = `ã‚¹ã‚³ã‚¢: ${score}`;
            
            // é€Ÿåº¦ä¸Šæ˜‡ã¨é›£æ˜“åº¦ä¸Šæ˜‡
            speedIncreaseTimer++;
            if (speedIncreaseTimer > 300) {
                gameSpeed += 0.3;
                speedIncreaseTimer = 0;
                difficultyLevel++;  // é›£æ˜“åº¦ãƒ¬ãƒ™ãƒ«ã‚‚ä¸Šæ˜‡
                
                // é€Ÿåº¦ä¸Šæ˜‡ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã¨éŸ³
                player.color = `hsl(${Math.random() * 360}, 70%, 60%)`;
                playSpeedUpSound();
                
                // é›£æ˜“åº¦ä¸Šæ˜‡ã®è¦–è¦šãƒ•ã‚£ãƒ¼ãƒ‰ãƒãƒƒã‚¯ï¼ˆèƒŒæ™¯è‰²ã‚’å°‘ã—å¤‰åŒ–ï¼‰
                if (difficultyLevel > 3) {
                    canvas.style.filter = `hue-rotate(${difficultyLevel * 5}deg)`;
                }
            }
            
            // è¡çªåˆ¤å®š
            if (checkCollision()) {
                gameOver();
            }
        }
        
        // æç”»
        function draw() {
            drawBackground();
            drawGround();
            drawObstacles();
            updateParticles();
            drawPlayer();
        }
        
        // ã‚²ãƒ¼ãƒ ãƒ«ãƒ¼ãƒ—
        function gameLoop() {
            update();
            draw();
            
            if (gameRunning) {
                requestAnimationFrame(gameLoop);
            }
        }
        
        // ã‚²ãƒ¼ãƒ é–‹å§‹
        async function startGame() {
            // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ãªã„å ´åˆã¯åˆæœŸåŒ–
            if (!audioInitialized) {
                await initAudio();
            }
            
            gameRunning = true;
            score = 0;
            gameSpeed = 3;
            speedIncreaseTimer = 0;
            obstacles = [];
            particles = [];
            obstacleTimer = 0;
            lastObstacleScored = null;
            
            // é›£æ˜“åº¦ã‚’ãƒªã‚»ãƒƒãƒˆ
            difficultyLevel = 0;
            baseObstacleInterval = 100;
            obstacleRandomness = 20;
            canvas.style.filter = 'none';  // èƒŒæ™¯è‰²åŠ¹æœã‚‚ãƒªã‚»ãƒƒãƒˆ
            
            player.y = 200;
            player.velocityY = 0;
            player.jumping = false;
            player.rotation = 0;
            player.color = '#FF6B6B';
            player.isCharging = false;
            player.chargeTime = 0;
            player.chargeColor = '#FF6B6B';
            
            initBackground();
            
            overlay.classList.remove('show');
            highScoreDisplay.textContent = `ãƒã‚¤ã‚¹ã‚³ã‚¢: ${highScore}`;
            
            // BGMã‚’åœæ­¢ã—ã¦ã‹ã‚‰å†é–‹ï¼ˆç¢ºå®Ÿã«ãƒªã‚¹ã‚¿ãƒ¼ãƒˆã•ã›ã‚‹ï¼‰
            stopBGM();
            setTimeout(() => {
                startBGM();
            }, 100);
            
            gameLoop();
        }
        
        // ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼
        function gameOver() {
            gameRunning = false;
            stopBGM();
            playGameOverSound();
            
            // èƒŒæ™¯è‰²åŠ¹æœã‚’ãƒªã‚»ãƒƒãƒˆ
            canvas.style.filter = 'none';
            
            // ãƒãƒ£ãƒ¼ã‚¸çŠ¶æ…‹ã‚’ãƒªã‚»ãƒƒãƒˆ
            player.isCharging = false;
            player.chargeTime = 0;
            
            if (score > highScore) {
                highScore = score;
                localStorage.setItem('highScore', highScore);
            }
            
            overlay.innerHTML = `
                <h1 class="gameTitle">ã‚²ãƒ¼ãƒ ã‚ªãƒ¼ãƒãƒ¼</h1>
                <p class="gameText">ã‚¹ã‚³ã‚¢: ${score}</p>
                <p class="gameText" style="color: #FFD700;">ãƒã‚¤ã‚¹ã‚³ã‚¢: ${highScore}</p>
                <button class="button" onclick="startGame()">ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤</button>
            `;
            overlay.classList.add('show');
        }
        
        // åˆæœŸåŒ–ã—ã¦é–‹å§‹
        async function initAndStart() {
            if (!audioInitialized) {
                await initAudio();
            }
            startGame();
        }
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
        let isSpacePressed = false;
        let mouseDownTimer = null;
        
        // ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰æ“ä½œ
        document.addEventListener('keydown', (e) => {
            if (e.code === 'Space' && !isSpacePressed) {
                e.preventDefault();
                isSpacePressed = true;
                startJumpCharge();
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (e.code === 'Space') {
                e.preventDefault();
                isSpacePressed = false;
                executeJump();
            }
        });
        
        // ãƒã‚¦ã‚¹æ“ä½œ
        canvas.addEventListener('mousedown', (e) => {
            e.preventDefault();
            startJumpCharge();
            mouseDownTimer = Date.now();
        });
        
        canvas.addEventListener('mouseup', (e) => {
            e.preventDefault();
            const pressDuration = mouseDownTimer ? Date.now() - mouseDownTimer : 0;
            
            // éå¸¸ã«çŸ­ã„ã‚¯ãƒªãƒƒã‚¯ï¼ˆ100msæœªæº€ï¼‰ã¯å³ã‚¸ãƒ£ãƒ³ãƒ—ã¨ã—ã¦æ‰±ã†
            if (pressDuration < 100 && !player.jumping && gameRunning) {
                player.isCharging = false;
                player.chargeTime = 0;
                player.velocityY = player.minJumpPower;
                player.jumping = true;
                playJumpSound(0);
            } else {
                executeJump();
            }
            mouseDownTimer = null;
        });
        
        // ãƒã‚¦ã‚¹ãŒã‚­ãƒ£ãƒ³ãƒã‚¹ã‹ã‚‰é›¢ã‚ŒãŸå ´åˆã‚‚ã‚¸ãƒ£ãƒ³ãƒ—å®Ÿè¡Œ
        canvas.addEventListener('mouseleave', (e) => {
            if (player.isCharging) {
                executeJump();
            }
            mouseDownTimer = null;
        });
        
        // ã‚¿ãƒƒãƒæ“ä½œï¼ˆãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œï¼‰
        let touchStartTime = null;
        
        canvas.addEventListener('touchstart', (e) => {
            e.preventDefault();
            startJumpCharge();
            touchStartTime = Date.now();
        });
        
        canvas.addEventListener('touchend', (e) => {
            e.preventDefault();
            const pressDuration = touchStartTime ? Date.now() - touchStartTime : 0;
            
            // éå¸¸ã«çŸ­ã„ã‚¿ãƒƒãƒ—ï¼ˆ100msæœªæº€ï¼‰ã¯å³ã‚¸ãƒ£ãƒ³ãƒ—ã¨ã—ã¦æ‰±ã†
            if (pressDuration < 100 && !player.jumping && gameRunning) {
                player.isCharging = false;
                player.chargeTime = 0;
                player.velocityY = player.minJumpPower;
                player.jumping = true;
                playJumpSound(0);
            } else {
                executeJump();
            }
            touchStartTime = null;
        });
        
        // ã‚¿ãƒƒãƒã‚­ãƒ£ãƒ³ã‚»ãƒ«æ™‚ã‚‚ã‚¸ãƒ£ãƒ³ãƒ—å®Ÿè¡Œ
        canvas.addEventListener('touchcancel', (e) => {
            if (player.isCharging) {
                executeJump();
            }
            touchStartTime = null;
        });
        
        // åˆæœŸè¡¨ç¤º
        initBackground();
        draw();
        highScoreDisplay.textContent = `ãƒã‚¤ã‚¹ã‚³ã‚¢: ${highScore}`;
    </script>
</body>
</html>